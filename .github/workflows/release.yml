name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate version file
        run: |
          # Generate _version.py for runtime version access
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION="${VERSION#v}"  # Strip 'v' prefix (v0.11.1 -> 0.11.1)
          printf '%s\n' \
            "# Generated by release workflow from tag v${VERSION}" \
            "__version__ = \"${VERSION}\"" \
            > src/ia_utils/_version.py
          cat src/ia_utils/_version.py

      - name: Patch pyproject.toml fallback version
        run: |
          # Update fallback-version to match the release tag
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION="${VERSION#v}"
          sed -i "s/^fallback-version = .*/fallback-version = \"${VERSION}\"/" pyproject.toml
          grep fallback-version pyproject.toml

      - name: Create skill zip
        run: |
          # Create zip with ia-utils/ as root directory
          # Works as both a skill (directory name matches skill name)
          # and Python package (contains pyproject.toml, src/)
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p /tmp/ia-utils
          rsync -a --exclude='.git' \
                   --exclude='.github' \
                   --exclude='.venv' \
                   --exclude='.pytest_cache' \
                   --exclude='__pycache__' \
                   --exclude='*.pyc' \
                   --exclude='.DS_Store' \
                   --exclude='*.sqlite' \
                   . /tmp/ia-utils/
          cd /tmp
          zip -r $GITHUB_WORKSPACE/ia-utils-${VERSION}.zip ia-utils
          cp $GITHUB_WORKSPACE/ia-utils-${VERSION}.zip $GITHUB_WORKSPACE/ia-utils-${VERSION}.skill
          cp $GITHUB_WORKSPACE/ia-utils-${VERSION}.zip $GITHUB_WORKSPACE/ia-utils.zip
          cp $GITHUB_WORKSPACE/ia-utils-${VERSION}.zip $GITHUB_WORKSPACE/ia-utils.skill

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            ia-utils-${{ steps.version.outputs.VERSION }}.zip
            ia-utils-${{ steps.version.outputs.VERSION }}.skill
            ia-utils.zip
            ia-utils.skill
